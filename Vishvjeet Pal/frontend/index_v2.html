<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Task Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  color: #333;
}

.hidden { display: none !important; }

/* Header */
header { 
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  padding: 20px 30px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#userInfo {
  font-size: 16px;
  font-weight: 500;
}

/* comments */
.task-comments {
  flex: 1;
  border-left: 1px solid #e5e7eb;
  padding-left: 15px;
  display: flex;
  flex-direction: column;
  max-height: 220px;  
}


.task-comments h4 {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: #4f46e5;
}

/* Scrollable list */
.comments-list {
  flex: 1;
  overflow-y: auto;
  padding-right: 6px;
  margin-bottom: 8px;
}


.comment {
  font-size: 13px;
  background: #f3f4f6;
  padding: 6px 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  display: flex; /* Added for alignment */
  justify-content: space-between;
  align-items: flex-start;
  position: relative;
}

.comment-text-wrapper {
  flex: 1;
}

.delete-comment-btn {
  background: none;
  border: none;
  color: #9ca3af;
  font-size: 16px;
  cursor: pointer;
  padding: 0 0 0 8px;
  line-height: 1;
  transition: color 0.2s;
}

.delete-comment-btn:hover {
  color: #ef4444;
  background: none; /* Override general button hover */
  transform: scale(1.2);
  box-shadow: none;
}

.comment small {
  display: block;
  font-size: 11px;
  color: #6b7280;
}


/* Input fixed at bottom */
.comment-input {
  width: 100%;
  font-size: 13px;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #d1d5db;
}

/* Buttons */
button {
  padding: 10px 20px;
  cursor: pointer;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s ease;
  background: #4f46e5;
  color: white;
}

button:hover {
  background: #4338ca;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
}

header button {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
}

header button:hover {
  background: rgba(255,255,255,0.3);
}

/* Navigation Section */
section.nav-section {
  background: white;
  padding: 20px 30px;
  margin: 20px auto;
  max-width: 1400px;
  border-radius: 12px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.07);
  display: flex;
  gap: 10px;
}

section.nav-section button {
  background: #f3f4f6;
  color: #4f46e5;
  border: 2px solid transparent;
}

section.nav-section button:hover {
  background: #e0e7ff;
  border-color: #4f46e5;
}

/* Content Sections */
section:not(.nav-section) {
  padding: 30px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Cards */
.card {
  background: white;
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  transform: translateY(-2px);
}

/* Login Screen */
#loginScreen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
}

#loginScreen .card {
  max-width: 400px;
  width: 100%;
}

#loginScreen h2 {
  margin-bottom: 20px;
  color: #4f46e5;
  font-size: 28px;
}

/* Forms */
form {
  margin-bottom: 20px;
}

input, select {
  padding: 12px 16px;
  margin-bottom: 12px;
  width: 100%;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: #4f46e5;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

th, td {
  padding: 16px;
  text-align: left;
  border-bottom: 1px solid #f3f4f6;
}

th {
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
}

tr:hover {
  background: #f9fafb;
}

/* Task Cards */
.task-card {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: #333;
  background: white;
  padding: 20px;
  margin-bottom: 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid #4f46e5;
  transition: all 0.3s ease;
}

/* Horizontal split */
.task-content {
  display: flex;
  gap: 20px;
  min-height: 220px;   /* üëà critical */
}

.task-main {
  flex: 2;
}

.task-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  transform: translateX(4px);
}

.task-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.task-title {
  font-size: 18px;
  font-weight: 600;
  color: #1f2937;
}

.task-status {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-pending {
  background: #fef3c7;
  color: #92400e;
}

.status-in_progress {
  background: #dbeafe;
  color: #1e40af;
}

.status-completed {
  background: #d1fae5;
  color: #065f46;
}

.task-details {
  margin: 12px 0;
  color: #6b7280;
  font-size: 14px;
}

.task-meta {
  display: flex;
  gap: 20px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.task-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  color: #6b7280;
}

.task-meta-label {
  font-weight: 600;
  color: #4b5563;
}

.task-actions {
  margin-top: 15px;
  display: flex;
  gap: 10px;
}

.task-actions button {
  padding: 8px 16px;
  font-size: 13px;
}

.delete-btn {
  background: #ef4444;
}

.delete-btn:hover {
  background: #dc2626;
}

/* Priority Badge */
.priority-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
}

.priority-low {
  background: #e0e7ff;
  color: #4338ca;
}

.priority-medium {
  background: #fed7aa;
  color: #c2410c;
}

.priority-high {
  background: #fecaca;
  color: #b91c1c;
}

/* Section Headers */
h3 {
  color: #1f2937;
  font-size: 24px;
  margin-bottom: 20px;
  padding-bottom: 10px;
  border-bottom: 3px solid #4f46e5;
  display: inline-block;
}

/* Role Cards */
#roleList .card {
  border-left: 4px solid #10b981;
}

#roleList .card b {
  color: #1f2937;
  font-size: 18px;
  display: block;
  margin-bottom: 10px;
}

/* Filter and Pagination Controls */
.controls-container {
  background: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.filter-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group label {
  font-size: 12px;
  font-weight: 600;
  color: #6b7280;
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.filter-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
  flex-wrap: wrap;
}

.filter-btn {
  background: #4f46e5;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
}

.filter-btn:hover {
  background: #4338ca;
  transform: translateY(-2px);
}

.reset-btn {
  background: #6b7280;
}

.reset-btn:hover {
  background: #4b5563;
}

/* Pagination */
.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.pagination button {
  padding: 8px 16px;
  background: #f3f4f6;
  color: #4f46e5;
  border: 2px solid transparent;
  min-width: 40px;
}

.pagination button:hover:not(:disabled) {
  background: #e0e7ff;
  border-color: #4f46e5;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.pagination .page-info {
  padding: 8px 16px;
  font-weight: 600;
  color: #4b5563;
}

.pagination input[type="number"] {
  width: 80px;
  padding: 8px;
  text-align: center;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  margin: 0;
}

.page-size-selector {
  display: flex;
  align-items: center;
  gap: 8px;
}

.page-size-selector select {
  width: auto;
  padding: 8px 12px;
  margin: 0;
}

/* Search Input */
.search-box {
  position: relative;
  flex: 1;
  min-width: 200px;
}

.search-box input {
  padding-left: 40px;
  margin: 0;
}

.search-box::before {
  content: "üîç";
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 16px;
}


/* ========== CHATBOT STYLES ========== */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}

.chatbot-button {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  transition: all 0.3s ease;
}

.chatbot-button:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 16px rgba(79, 70, 229, 0.5);
}

.chatbot-window {
  position: fixed;
  bottom: 90px;
  right: 20px;
  width: 380px;
  height: 500px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transform: scale(0);
  transform-origin: bottom right;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.chatbot-window.active {
  transform: scale(1);
  opacity: 1;
}

.chatbot-header {
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chatbot-header h4 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.chatbot-close {
  background: transparent;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.3s ease;
}

.chatbot-close:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: none;
  box-shadow: none;
}

.chatbot-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: #f9fafb;
}

.chatbot-message {
  display: flex;
  gap: 8px;
  animation: messageSlide 0.3s ease;
}

@keyframes messageSlide {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.chatbot-message.user {
  justify-content: flex-end;
}

.chatbot-message.bot {
  justify-content: flex-start;
}

.message-bubble {
  max-width: 70%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
  word-wrap: break-word;
}

.chatbot-message.user .message-bubble {
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  border-bottom-right-radius: 4px;
}

.chatbot-message.bot .message-bubble {
  background: white;
  color: #333;
  border-bottom-left-radius: 4px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.chatbot-typing {
  display: flex;
  gap: 4px;
  padding: 10px 14px;
  background: white;
  border-radius: 12px;
  width: fit-content;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #9ca3af;
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
    opacity: 0.7;
  }
  30% {
    transform: translateY(-10px);
    opacity: 1;
  }
}

.chatbot-input-container {
  padding: 16px;
  background: white;
  border-top: 1px solid #e5e7eb;
  display: flex;
  gap: 8px;
}

.chatbot-input {
  flex: 1;
  padding: 10px 14px;
  border: 2px solid #e5e7eb;
  border-radius: 20px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.3s ease;
  margin: 0;
}

.chatbot-input:focus {
  border-color: #4f46e5;
}

.chatbot-send {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
  color: white;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
  padding: 0;
}

.chatbot-send:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
}

.chatbot-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

/* Scrollbar styling for chatbot */
.chatbot-messages::-webkit-scrollbar {
  width: 6px;
}

.chatbot-messages::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.chatbot-messages::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 3px;
}

.chatbot-messages::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* Responsive */
@media (max-width: 768px) {
  header {
    padding: 15px 20px;
  }
  
  section.nav-section {
    flex-direction: column;
  }
  
  .task-meta {
    flex-direction: column;
    gap: 8px;
  }
  
  .filter-section {
    grid-template-columns: 1fr;
  }
  
  .pagination {
    flex-wrap: wrap;
  }

  .chatbot-window {
    width: calc(100vw - 40px);
    height: calc(100vh - 140px);
    right: 20px;
    bottom: 90px;
  }
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginScreen">
  <section class="card">
    <h2>Login</h2>
    <form onsubmit="login(event)">
      <input id="email" placeholder="Email" required /><br>
      <input id="password" type="password" placeholder="Password" required /><br>
      <button>Login</button>
    </form>
  </section>
</div>

<!-- APP -->
<div id="app" class="hidden">
<header>
  <span id="userInfo"></span>
  <button onclick="logout()">Logout</button>
</header>

<section class="nav-section">
  <button onclick="show('tasks')">üìã Tasks</button>
  <button onclick="show('users')" id="usersBtn">üë• Users</button>
  <button onclick="show('roles')" id="rolesBtn">üîê Roles</button>
  <button onclick="show('logs')" id="logsBtn">üìä Audit Logs</button>
</section>

<!-- TASKS -->
<section id="tasks" class="hidden">
  <h3>Tasks</h3>

  <!-- TASK CREATION FORM -->
  <form id="taskForm">
    <input type="text" id="taskTitle" placeholder="Title" required />
    <input type="text" id="taskDescription" placeholder="Description" />
    <select id="taskPriority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>
    <select id="taskStatus">
      <option value="pending" selected>Pending</option>
      <option value="in_progress">In Progress</option>
      <option value="completed">Completed</option>
    </select>
    <input type="date" id="taskDeadline" />
    <input type="number" id="taskAssignedTo" placeholder="Assigned To (User ID)" />
    <button type="submit" id="createTaskBtn">Create Task</button>
  </form>

  <!-- TASK FILTERS -->
  <div class="controls-container">
    <div class="filter-section">
      <!-- <div class="filter-group search-box">
        <label>Search</label>
        <input type="text" id="taskSearch" placeholder="Search tasks..." />
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select id="taskStatusFilter">
          <option value="">All</option>
          <option value="pending">Pending</option>
          <option value="in_progress">In Progress</option>
          <option value="completed">Completed</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Priority</label>
        <select id="taskPriorityFilter">
          <option value="">All</option>
          <option value="low">Low</option>
          <option value="medium">Medium</option>
          <option value="high">High</option>
        </select>
      </div> -->
      <div class="filter-group">
        <label>Assigned To</label>
        <input type="number" id="taskAssignedToFilter" placeholder="User ID" />
      </div>
    </div>
    <div class="filter-actions">
      <button class="filter-btn" onclick="applyTaskFilters()">Apply Filters</button>
      <button class="reset-btn" onclick="resetTaskFilters()">Reset</button>
    </div>
  </div>

<div id="updateTaskForm" class="card hidden">
  <h3>Update Task</h3>

  <form id="updateTaskFormInner">
    <input type="text" id="newTitle" placeholder="Title"/>
    <input type="text" id="newDescription" placeholder="Description" />

    <select id="newPriority">
      <option value="low">Low</option>
      <option value="medium" selected>Medium</option>
      <option value="high">High</option>
    </select>

    <select id="newStatus">
      <option value="pending" selected>Pending</option>
      <option value="in_progress">In Progress</option>
      <option value="completed">Completed</option>
    </select>

    <input type="date" id="newDeadline" />
    <input type="number" id="newAssignedTo" placeholder="User ID" />

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button type="submit">Update Task</button>
      <button type="button" class="reset-btn" onclick="closeUpdateTask()">Cancel</button>
    </div>
  </form>
</div>


  <div id="taskList"></div>

  <!-- TASK PAGINATION -->
  <div class="pagination" id="taskPagination">
    <button onclick="changeTaskPage('first')">First</button>
    <button onclick="changeTaskPage('prev')">Previous</button>
    <span class="page-info">Page <span id="taskCurrentPage">1</span> of <span id="taskTotalPages">1</span></span>
    <button onclick="changeTaskPage('next')">Next</button>
    <button onclick="changeTaskPage('last')">Last</button>
    <div class="page-size-selector">
      <label>Per page:</label>
      <select id="taskPageSize" onchange="changeTaskPageSize()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
    </div>
  </div>
</section>

<!-- USERS -->
<section id="users" class="hidden">
  <h3>Users</h3>
  <button id="addUserBtn" onclick="createUser()" style="margin-bottom: 20px;">+ Add User</button>
  <!-- CREATE USER FORM -->
<div id="createUserForm" class="card hidden">
  <h3>Create User</h3>
  <form onsubmit="submitCreateUser(event)">
    <input type="text" id="newUserName" placeholder="Name" required />
    <input type="email" id="newUserEmail" placeholder="Email" required />
    <input type="text" id="newUserMobile" placeholder="Mobile" required />
    <input type="text" id="newUserTeam" placeholder="Team" required />
    <input type="number" id="newUserRole" placeholder="Role ID" required />
    <input type="password" id="newUserPassword" placeholder="Password" required />

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button type="submit">Create</button>
      <button type="button" class="reset-btn" onclick="closeCreateUser()">Cancel</button>
    </div>
  </form>
</div>


  <!-- USER FILTERS -->
  <div class="controls-container">
    <div class="filter-section">
      <div class="filter-group">
        <label>Role ID</label>
        <input type="number" id="userRoleFilter" placeholder="Role ID" />
      </div>
    </div>
    <div class="filter-actions">
      <button class="filter-btn" onclick="applyUserFilters()">Apply Filters</button>
      <button class="reset-btn" onclick="resetUserFilters()">Reset</button>
    </div>
  </div>

  <table>
    <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Action</th></tr></thead>
    <tbody id="userTable"></tbody>
  </table>

  <!-- USER PAGINATION -->
  <div class="pagination" id="userPagination">
    <button onclick="changeUserPage('first')">First</button>
    <button onclick="changeUserPage('prev')">Previous</button>
    <span class="page-info">Page <span id="userCurrentPage">1</span> of <span id="userTotalPages">1</span></span>
    <button onclick="changeUserPage('next')">Next</button>
    <button onclick="changeUserPage('last')">Last</button>
    <div class="page-size-selector">
      <label>Per page:</label>
      <select id="userPageSize" onchange="changeUserPageSize()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
    </div>
  </div>
</section>

<!-- ROLES -->
<section id="roles" class="hidden">
  <h3>Roles</h3>
  <button onclick="openCreateRoleForm()" style="margin-bottom: 20px;">
  + Add Role
</button>
<div id="createRoleForm" class="card hidden">
  <h3>Create Role</h3>

  <form id="createRoleFormInner">
    <input
      type="text"
      id="roleName"
      placeholder="Role Name"
      required
    />

    <textarea
      id="rolePermissions"
      placeholder="Permissions (comma separated)"
      rows="3"
      required
    ></textarea>

    <div style="display:flex; gap:10px; margin-top:10px;">
      <button type="submit">Create Role</button>
      <button
        type="button"
        class="reset-btn"
        onclick="closeCreateRoleForm()"
      >
        Cancel
      </button>
    </div>
  </form>
</div>


  <!-- ROLE FILTERS -->
  <div class="controls-container">
    <div class="filter-section">
      <div class="filter-group search-box">
        <label>Search</label>
        <input type="text" id="roleSearch" placeholder="Search roles..." />
      </div>
    </div>
    <div class="filter-actions">
      <button class="filter-btn" onclick="applyRoleFilters()">Apply Filters</button>
      <button class="reset-btn" onclick="resetRoleFilters()">Reset</button>
    </div>
  </div>

  <div id="roleList"></div>

  <!-- ROLE PAGINATION -->
  <div class="pagination" id="rolePagination">
    <button onclick="changeRolePage('first')">First</button>
    <button onclick="changeRolePage('prev')">Previous</button>
    <span class="page-info">Page <span id="roleCurrentPage">1</span> of <span id="roleTotalPages">1</span></span>
    <button onclick="changeRolePage('next')">Next</button>
    <button onclick="changeRolePage('last')">Last</button>
    <div class="page-size-selector">
      <label>Per page:</label>
      <select id="rolePageSize" onchange="changeRolePageSize()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
    </div>
  </div>
</section>

<!-- LOGS -->
<section id="logs" class="hidden">
  <h3>Audit Logs</h3>

  <!-- LOG FILTERS -->
  <div class="controls-container">
    <div class="filter-section">
      <!-- <div class="filter-group">
        <label>Action</label>
        <input type="text" id="logActionFilter" placeholder="Action" />
      </div>
      <div class="filter-group">
        <label>Entity</label>
        <input type="text" id="logEntityFilter" placeholder="Entity" />
      </div> -->
      <div class="filter-group">
        <label>Actor ID</label>
        <input type="number" id="logActorFilter" placeholder="Actor ID" />
      </div>
    </div>
    <div class="filter-actions">
      <button class="filter-btn" onclick="applyLogFilters()">Apply Filters</button>
      <button class="reset-btn" onclick="resetLogFilters()">Reset</button>
    </div>
  </div>

  <table>
    <thead><tr><th>User</th><th>Action</th><th>Entity</th><th>Time</th></tr></thead>
    <tbody id="logTable"></tbody>
  </table>

  <!-- LOG PAGINATION -->
  <div class="pagination" id="logPagination">
    <button onclick="changeLogPage('first')">First</button>
    <button onclick="changeLogPage('prev')">Previous</button>
    <span class="page-info">Page <span id="logCurrentPage">1</span> of <span id="logTotalPages">1</span></span>
    <button onclick="changeLogPage('next')">Next</button>
    <button onclick="changeLogPage('last')">Last</button>
    <div class="page-size-selector">
      <label>Per page:</label>
      <select id="logPageSize" onchange="changeLogPageSize()">
        <option value="5">5</option>
        <option value="10" selected>10</option>
        <option value="20">20</option>
        <option value="50">50</option>
      </select>
    </div>
  </div>
</section>

<!-- CHATBOT -->
<div class="chatbot-container">
  <button class="chatbot-button" onclick="toggleChatbot()" id="chatbotToggle">
    üí¨
  </button>
  
  <div class="chatbot-window" id="chatbotWindow">
    <div class="chatbot-header">
      <h4>ü§ñ Assistant</h4>
      <button class="chatbot-close" onclick="toggleChatbot()">√ó</button>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="chatbot-message bot">
        <div class="message-bubble">
          Hello! I'm your task management assistant. How can I help you today?
        </div>
      </div>
    </div>
    
    <div class="chatbot-input-container">
      <input 
        type="text" 
        class="chatbot-input" 
        id="chatbotInput" 
        placeholder="Type your message..."
        onkeypress="handleChatbotEnter(event)"
      />
      <button class="chatbot-send" onclick="sendChatbotMessage()" id="chatbotSend">
        ‚û§
      </button>
    </div>
  </div>
</div>

</div>

<script>
const API = "http://localhost:8000";
let token = localStorage.getItem("access_token");
let permissions = [];

// Pagination and Filter State
let taskState = { page: 1, size: 10, filters: {} };
let userState = { page: 1, size: 10, filters: {} };
let roleState = { page: 1, size: 10, filters: {} };
let logState = { page: 1, size: 10, filters: {} };

/* ---------- UTILS ---------- */
function api(url, options={}) {
  return fetch(API+url, {
    ...options,
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${token}`
    }
  });
}

function decodeToken() {
  const payload = JSON.parse(atob(token.split(".")[1]));
  permissions = payload.permissions || [];
  document.getElementById("userInfo").innerText =
    `${payload.name || "User"} (${payload.role || "Role"})`;
}

function has(p) { return permissions.includes(p); }

function buildQueryString(params) {
  const query = new URLSearchParams();
  for (const [key, value] of Object.entries(params)) {
    if (value !== null && value !== undefined && value !== '') {
      query.append(key, value);
    }
  }
  return query.toString();
}

/* ---------- AUTH ---------- */
async function login(e) {
  e.preventDefault();

  const formData = new URLSearchParams();
  formData.append("username", email.value);
  formData.append("password", password.value);

  const res = await fetch(API + "/auth/login", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: formData.toString(),
  });

  if (!res.ok) return alert("Invalid login");

  const data = await res.json();
  token = data.access_token;
  localStorage.setItem("access_token", token);
  startApp();
}

function logout() {
  localStorage.removeItem("access_token");
  location.reload();
}

function startApp() {
  decodeToken();
  loginScreen.classList.add("hidden");
  app.classList.remove("hidden");

  // UI permission enforcement
  if(!has("view_users")) usersBtn.style.display="none";
  if(!has("manage_role")) rolesBtn.style.display="none";
  if(!has("view_audit_logs")) logsBtn.style.display="none";
  if(!has("create_task")) document.getElementById("taskForm").style.display="none";
  if(!has("create_user")) {document.getElementById("addUserBtn").style.display = "none";}


  show("tasks");
}

/* ---------- NAV ---------- */
function show(id) {
  ["tasks","users","roles","logs"].forEach(s =>
    document.getElementById(s).classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");

  if(id==="tasks") loadTasks();
  if(id==="users") loadUsers();
  if(id==="roles") loadRoles();
  if(id==="logs") loadLogs();
}

/* ---------- TASKS ---------- */

async function loadComments(taskId) {
  const container = document.getElementById(`comments-${taskId}`);
  if (!container) return;

  const res = await api(`/comments/task/${taskId}`);
  if (!res.ok) {
    container.innerHTML = `<div class="comment">Failed to load comments</div>`;
    return;
  }

  const comments = await res.json();
  container.innerHTML = "";

  if (!comments.length) {
    container.innerHTML = `
      <div style="font-size:12px;color:#9ca3af;padding: 5px;">
        No comments yet
      </div>`;
    return;
  }

  comments.forEach(c => {
    container.innerHTML += `
      <div class="comment">
        <div class="comment-text-wrapper">
          <strong>#${c.c_id}</strong> ${c.content}
          <small>
            User #${c.e_id} ¬∑ ${new Date(c.timestamp).toLocaleString()}
          </small>
        </div>
        ${has("delete_comment") || true ? `
          <button class="delete-comment-btn" onclick="deleteComment(${c.c_id}, ${taskId})" title="Delete Comment">
            &times;
          </button>` : ""}
      </div>`;
  });
}

async function deleteComment(commentId, taskId) {
  if (!confirm("Are you sure you want to delete this comment?")) return;

  try {
    // Note: c_id is used in your API endpoint
    const res = await api(`/comments/${commentId}`, {
      method: "DELETE"
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.detail || "Failed to delete comment");
    }

    // Refresh the comments list for this task
    loadComments(taskId);
  } catch (error) {
    console.error("Delete error:", error);
    alert(error.message);
  }
}

async function addComment(e, taskId) {
  if (e.key !== "Enter") return;

  const text = e.target.value.trim();
  if (!text) return;

  const res = await api(`/comments/task/${taskId}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ content:text })
  });

  if (!res.ok) {
    alert("Failed to add comment");
    return;
  }

  e.target.value = "";
  loadComments(taskId); 
}


async function loadTasks() {
  let baseUrl = "/tasks/";
  const filters = { ...taskState.filters };

  if (filters.assigned_to) {
    baseUrl = `/tasks/${filters.assigned_to}`;
    delete filters.assigned_to;
  }

  const params = {
    page: taskState.page,
    size: taskState.size,
    ...filters
  };

  const queryString = buildQueryString(params);
  const res = await api(`${baseUrl}?${queryString}`);

  if (!res.ok) {
    taskList.innerHTML = `
      <div class="task-card">
        <div class="task-header">
          <div class="task-title">No Tasks Assigned to User ID: ${taskState.filters.assigned_to}</div>
        </div>
      </div>`;
    return;
  }

  const data = await res.json();
  taskList.innerHTML = "";

  data.data.forEach(t => {
    const statusClass = `status-${t.status}`;
    const priorityClass = `priority-${t.priority}`;

    taskList.innerHTML += `
      <div class="task-card">
        <div class="task-content">

          <!-- LEFT: task info -->
          <div class="task-main">
            <div class="task-header">
              <div class="task-title">${t.title}</div>
              <span class="task-status ${statusClass}">
                ${t.status.replace("_", " ")}
              </span>
            </div>

            <div class="task-details">${t.description || "No description"}</div>

            <div class="task-meta">
              <div class="task-meta-item">
                <span class="task-meta-label">Priority:</span>
                <span class="priority-badge ${priorityClass}">${t.priority}</span>
              </div>

              ${t.deadline ? `
              <div class="task-meta-item">
                <span class="task-meta-label">Deadline:</span>
                <span>${new Date(t.deadline).toLocaleDateString()}</span>
              </div>` : ""}

              ${t.assigned_to ? `
              <div class="task-meta-item">
                <span class="task-meta-label">Assigned To:</span>
                <span>User #${t.assigned_to}</span>
              </div>` : ""}

              ${t.assigned_by ? `
              <div class="task-meta-item">
                <span class="task-meta-label">Assigned By:</span>
                <span>User #${t.assigned_by}</span>
              </div>` : ""}
            </div>

            ${has("delete_task") ? `
            <div class="task-actions">
              <button class="delete-btn" onclick="deleteTask(${t.task_id})">Delete Task</button>
              <button class="filter-btn" onclick="updateTask(${t.task_id})">Update Task</button>
            </div>` : ""}
          </div>

          <!-- RIGHT: comments -->
          <div class="task-comments">
            <h4>Comments</h4>

            <div class="comments-list" id="comments-${t.task_id}">
              <div style="font-size:12px;color:#9ca3af;">Loading comments‚Ä¶</div>
            </div>

            <input class="comment-input" placeholder="Add a comment..." onkeydown="addComment(event, ${t.task_id})"/>
          </div>

        </div>
      </div>`;
      setTimeout(() => loadComments(t.task_id), 0);
  });


  updateTaskPagination(data.total, data.page, data.size);
}

function updateTaskPagination(total, page, size) {
  const totalPages = Math.ceil(total / size);
  document.getElementById('taskCurrentPage').textContent = page;
  document.getElementById('taskTotalPages').textContent = totalPages;
  
  const pagination = document.getElementById('taskPagination');
  const buttons = pagination.querySelectorAll('button');
  buttons[0].disabled = page === 1; // First
  buttons[1].disabled = page === 1; // Previous
  buttons[2].disabled = page === totalPages; // Next
  buttons[3].disabled = page === totalPages; // Last
}

function applyTaskFilters() {
  taskState.filters = {};
  taskState.page = 1;
  
  // const search = document.getElementById('taskSearch').value.trim();
  // const status = document.getElementById('taskStatusFilter').value;
  // const priority = document.getElementById('taskPriorityFilter').value;
  const assignedTo = document.getElementById('taskAssignedToFilter').value;
  
  // if (search) taskState.filters.search = search;
  // if (status) taskState.filters.status = status;
  // if (priority) taskState.filters.priority = priority;
  if (assignedTo) taskState.filters.assigned_to = assignedTo;
  
  loadTasks();
}

function resetTaskFilters() {
  // document.getElementById('taskSearch').value = '';
  // document.getElementById('taskStatusFilter').value = '';
  // document.getElementById('taskPriorityFilter').value = '';
  document.getElementById('taskAssignedToFilter').value = '';
  taskState.filters = {};
  taskState.page = 1;
  loadTasks();
}

function changeTaskPage(action) {
  const totalPages = parseInt(document.getElementById('taskTotalPages').textContent);
  
  if (action === 'first') taskState.page = 1;
  else if (action === 'prev' && taskState.page > 1) taskState.page--;
  else if (action === 'next' && taskState.page < totalPages) taskState.page++;
  else if (action === 'last') taskState.page = totalPages;
  
  loadTasks();
}

function changeTaskPageSize() {
  taskState.size = parseInt(document.getElementById('taskPageSize').value);
  taskState.page = 1;
  loadTasks();
}

/* ---------- CREATE TASK ---------- */
document.getElementById("taskForm").onsubmit = async function(e) {
  e.preventDefault();
  const title = document.getElementById("taskTitle").value;
  const description = document.getElementById("taskDescription").value;
  const priority = document.getElementById("taskPriority").value;
  const status = document.getElementById("taskStatus").value;
  const deadline = document.getElementById("taskDeadline").value || null;
  const assigned_to = document.getElementById("taskAssignedTo").value || null;

  const res = await api("/tasks/", {
    method: "POST",
    body: JSON.stringify({
      title,
      description,
      priority,
      status,
      deadline,
      assigned_to: assigned_to ? parseInt(assigned_to) : null
    })
  });

  if(!res.ok) return alert("Failed to create task");
  document.getElementById("taskForm").reset();
  loadTasks();
}

/* ---------- DELETE TASK ---------- */
async function deleteTask(id) {
  if(!confirm("Delete?")) return;
  await api(`/tasks/${id}`,{ method:"DELETE" });
  loadTasks();
}

// document.getElementById("updateTaskForm").onsubmit = async function(e) {

let currentTaskId = null;

/* ---------- OPEN UPDATE FORM ---------- */
function updateTask(id) {
  currentTaskId = id;
  document.getElementById("updateTaskForm").classList.remove("hidden");
}

/* ---------- SUBMIT UPDATE ---------- */
document
  .getElementById("updateTaskFormInner")
  .addEventListener("submit", updateTaskForm);

async function updateTaskForm(e) {
  e.preventDefault();

  const title = document.getElementById("newTitle").value;
  const description = document.getElementById("newDescription").value;
  const priority = document.getElementById("newPriority").value;
  const status = document.getElementById("newStatus").value;
  const deadline = document.getElementById("newDeadline").value || null;
  const assigned_to = document.getElementById("newAssignedTo").value || null;

  const res = await api(`/tasks/edit/${currentTaskId}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      title,
      description,
      priority,
      status,
      deadline,
      assigned_to: assigned_to ? parseInt(assigned_to) : null
    })
  });

  if (!res.ok) {
    alert("Failed to update task");
    return;
  }

  document.getElementById("updateTaskFormInner").reset();
  closeUpdateTask();
  loadTasks();
}

/* ---------- CLOSE FORM ---------- */
function closeUpdateTask() {
  document.getElementById("updateTaskForm").classList.add("hidden");
  currentTaskId = null;
}


/* ---------- USERS ---------- */
async function loadUsers() {
  let baseUrl = "/users/";
  const filters = { ...userState.filters };

  if (filters.user_id) {
    baseUrl = `/users/${filters.user_id}`;
    delete filters.user_id;
  }

  // const params = {
  //   page: userState.page,
  //   size: userState.size,
  //   ...filters
  // };

  // const queryString = buildQueryString(params);
  const res = await api(`${baseUrl}`);
  const data = await res.json();
  
  userTable.innerHTML="";
  data.data.forEach(u=>{
    userTable.innerHTML+=`
      <tr>
        <td>${u.name}</td>
        <td>${u.email}</td>
        <td>${u.r_id}</td>
        <td>
          ${has("update_user") ?
          `<button onclick="assignRole(${u.e_id})">Change Role</button>`:""}
          ${has("delete_user") ? 
          `<button class="delete-btn" onclick="deleteUser(${u.e_id})">Delete User</button>`:""}
        </td>
      </tr>`;
  });
  
  updateUserPagination(data.total, data.page, data.size);
}

function updateUserPagination(total, page, size) {
  const totalPages = Math.ceil(total / size);
  document.getElementById('userCurrentPage').textContent = page;
  document.getElementById('userTotalPages').textContent = totalPages;
  
  const pagination = document.getElementById('userPagination');
  const buttons = pagination.querySelectorAll('button');
  buttons[0].disabled = page === 1;
  buttons[1].disabled = page === 1;
  buttons[2].disabled = page === totalPages;
  buttons[3].disabled = page === totalPages;
}

function applyUserFilters() {
  userState.filters = {};
  userState.page = 1;

  // const search = userSearch.value.trim();
  const role = userRoleFilter.value.trim();

  // if (search) userState.filters.search = search;
  if (role) userState.filters.user_id = role; 

  loadUsers();
}

async function deleteUser(id) {
  if(!confirm("Delete?")) return;
  await api(`/users/${id}`,{ method:"DELETE" });
  loadUsers();
}


function resetUserFilters() {
  // document.getElementById('userSearch').value = '';
  document.getElementById('userRoleFilter').value = '';
  userState.filters = {};
  userState.page = 1;
  loadUsers();
}

function changeUserPage(action) {
  const totalPages = parseInt(document.getElementById('userTotalPages').textContent);
  
  if (action === 'first') userState.page = 1;
  else if (action === 'prev' && userState.page > 1) userState.page--;
  else if (action === 'next' && userState.page < totalPages) userState.page++;
  else if (action === 'last') userState.page = totalPages;
  
  loadUsers();
}

function changeUserPageSize() {
  userState.size = parseInt(document.getElementById('userPageSize').value);
  userState.page = 1;
  loadUsers();
}

async function assignRole(uid) {
  const role = prompt("Role ID?");
  await api(`/users/${uid}/role?role_id=${role}`,{ method:"PUT" });
  loadUsers();
}

/* ---------- ROLES ---------- */
async function loadRoles() {
  const params = {
    page: roleState.page,
    size: roleState.size,
    ...roleState.filters
  };
  
  const queryString = buildQueryString(params);
  const res = await api(`/roles/?${queryString}`);
  const data = await res.json();
  
  roleList.innerHTML="";
  data.forEach(r=>{
    roleList.innerHTML+=`
      <div class="card">
        <b>${r.role}</b><br>
        <span style="color: #6b7280; font-size: 14px;">${r.permissions.join(", ")}</span>
        <div>
        <button class="delete-btn" onclick="deleteRole(${r.r_id})">Delete Role</button>
        </div>
      </div>`;
  });
  
  updateRolePagination(data.total, data.page, data.size);
}

function updateRolePagination(total, page, size) {
  const totalPages = Math.ceil(total / size);
  document.getElementById('roleCurrentPage').textContent = page;
  document.getElementById('roleTotalPages').textContent = totalPages;
  
  const pagination = document.getElementById('rolePagination');
  const buttons = pagination.querySelectorAll('button');
  buttons[0].disabled = page === 1;
  buttons[1].disabled = page === 1;
  buttons[2].disabled = page === totalPages;
  buttons[3].disabled = page === totalPages;
}

function applyRoleFilters() {
  roleState.filters = {};
  roleState.page = 1;
  
  const search = document.getElementById('roleSearch').value.trim();
  
  if (search) roleState.filters.search = search;
  
  loadRoles();
}

function resetRoleFilters() {
  document.getElementById('roleSearch').value = '';
  roleState.filters = {};
  roleState.page = 1;
  loadRoles();
}

function changeRolePage(action) {
  const totalPages = parseInt(document.getElementById('roleTotalPages').textContent);
  
  if (action === 'first') roleState.page = 1;
  else if (action === 'prev' && roleState.page > 1) roleState.page--;
  else if (action === 'next' && roleState.page < totalPages) roleState.page++;
  else if (action === 'last') roleState.page = totalPages;
  
  loadRoles();
}

function changeRolePageSize() {
  roleState.size = parseInt(document.getElementById('rolePageSize').value);
  roleState.page = 1;
  loadRoles();
}

document
  .getElementById("createRoleFormInner")
  .addEventListener("submit", createRole);

async function createRole(e) {
  e.preventDefault();

  const name = document.getElementById("roleName").value.trim();
  const permsInput = document
    .getElementById("rolePermissions")
    .value.trim();

  if (!name || !permsInput) {
    alert("All fields are required");
    return;
  }

  const permissions = permsInput
    .split(",")
    .map(p => p.trim())
    .filter(Boolean);

  const res = await api("/roles/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ role: name, permissions: permissions })
  });

  if (!res.ok) {
    alert("Failed to create role");
    return;
  }

  closeCreateRoleForm();
  loadRoles();
}


async function deleteRole(r_id){
  if(!confirm("Delete?")) return;
  await api(`/roles/${r_id}`,{ method:"DELETE" });
  loadRoles();
}

function openCreateRoleForm() {
  document.getElementById("createRoleForm").classList.remove("hidden");
}

function closeCreateRoleForm() {
  document.getElementById("createRoleForm").classList.add("hidden");
  document.getElementById("createRoleFormInner").reset();
}


/* ---------- LOGS ---------- */
async function loadLogs() {
  let baseUrl = "/activity-logs/";
  const filters = { ...logState.filters };

  if (filters.actor_id) {
    baseUrl = `/activity-logs/${filters.actor_id}`;
    delete filters.actor_id;
  }

  const params = {
    page: logState.page,
    size: logState.size,
    ...filters
  };

  const queryString = buildQueryString(params);
  const res = await api(`${baseUrl}?${queryString}`);
  const data = await res.json();
  
  logTable.innerHTML="";
  data.data.forEach(l=>{
    logTable.innerHTML+=`
      <tr>
        <td>${l.actor_id}</td>
        <td>${l.action}</td>
        <td>${l.entity}</td>
        <td>${new Date(l.timestamp).toLocaleString()}</td>
      </tr>`;
  });
  
  updateLogPagination(data.total, data.page, data.size);
}

function updateLogPagination(total, page, size) {
  const totalPages = Math.ceil(total / size);
  document.getElementById('logCurrentPage').textContent = page;
  document.getElementById('logTotalPages').textContent = totalPages;
  
  const pagination = document.getElementById('logPagination');
  const buttons = pagination.querySelectorAll('button');
  buttons[0].disabled = page === 1;
  buttons[1].disabled = page === 1;
  buttons[2].disabled = page === totalPages;
  buttons[3].disabled = page === totalPages;
}

function applyLogFilters() {
  logState.filters = {};
  logState.page = 1;
  
  // const action = document.getElementById('logActionFilter').value.trim();
  // const entity = document.getElementById('logEntityFilter').value.trim();
  const actor = document.getElementById('logActorFilter').value;
  
  // if (action) logState.filters.action = action;
  // if (entity) logState.filters.entity = entity;
  if (actor) logState.filters.actor_id = actor;
  
  loadLogs();
}

function resetLogFilters() {
  // document.getElementById('logActionFilter').value = '';
  // document.getElementById('logEntityFilter').value = '';
  document.getElementById('logActorFilter').value = '';
  logState.filters = {};
  logState.page = 1;
  loadLogs();
}

function changeLogPage(action) {
  const totalPages = parseInt(document.getElementById('logTotalPages').textContent);
  
  if (action === 'first') logState.page = 1;
  else if (action === 'prev' && logState.page > 1) logState.page--;
  else if (action === 'next' && logState.page < totalPages) logState.page++;
  else if (action === 'last') logState.page = totalPages;
  
  loadLogs();
}

function changeLogPageSize() {
  logState.size = parseInt(document.getElementById('logPageSize').value);
  logState.page = 1;
  loadLogs();
}
function createUser() {
  document.getElementById("createUserForm").classList.remove("hidden");
}
function closeCreateUser() {
  document.getElementById("createUserForm").classList.add("hidden");
  document.querySelector("#createUserForm form").reset();
}
async function submitCreateUser(e) {
  e.preventDefault();

  const payload = {
    name: document.getElementById("newUserName").value,
    email: document.getElementById("newUserEmail").value,
    mobile: document.getElementById("newUserMobile").value,
    team: document.getElementById("newUserTeam").value,
    r_id: parseInt(document.getElementById("newUserRole").value),
    password: document.getElementById("newUserPassword").value
  };

  const res = await api("/users/", {
    method: "POST",
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    const err = await res.json();
    return alert(err.detail || "Failed to create user");
  }

  closeCreateUser();
  loadUsers();
}

/* ---------- CHATBOT FUNCTIONS ---------- */
let chatbotMessages = [];

function toggleChatbot() {
  const chatbotWindow = document.getElementById('chatbotWindow');
  const chatbotToggle = document.getElementById('chatbotToggle');
  
  if (chatbotWindow.classList.contains('active')) {
    chatbotWindow.classList.remove('active');
    chatbotToggle.textContent = 'üí¨';
  } else {
    chatbotWindow.classList.add('active');
    chatbotToggle.textContent = '‚úï';
  }
}

function addChatMessage(message, isUser = false) {
  const messagesContainer = document.getElementById('chatbotMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `chatbot-message ${isUser ? 'user' : 'bot'}`;
  
  const bubbleDiv = document.createElement('div');
  bubbleDiv.className = 'message-bubble';
  bubbleDiv.style.whiteSpace = 'pre-wrap';
  bubbleDiv.textContent = message;
  
  messageDiv.appendChild(bubbleDiv);
  messagesContainer.appendChild(messageDiv);
  
  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showTypingIndicator() {
  const messagesContainer = document.getElementById('chatbotMessages');
  const typingDiv = document.createElement('div');
  typingDiv.className = 'chatbot-message bot';
  typingDiv.id = 'typingIndicator';
  
  const typingBubble = document.createElement('div');
  typingBubble.className = 'chatbot-typing';
  typingBubble.innerHTML = `
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
    <span class="typing-dot"></span>
  `;
  
  typingDiv.appendChild(typingBubble);
  messagesContainer.appendChild(typingDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

async function sendChatbotMessage() {
  const input = document.getElementById('chatbotInput');
  const sendBtn = document.getElementById('chatbotSend');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Add user message to chat
  addChatMessage(message, true);
  chatbotMessages.push({ role: 'user', content: message });
  
  // Clear input and disable send button
  input.value = '';
  sendBtn.disabled = true;
  
  // Show typing indicator
  showTypingIndicator();
  
  try {
    // Send message to chatbot API
    const res = await api(`/chat/?query=${encodeURIComponent(message)}`, {
      method: 'POST',
      body: JSON.stringify({ query: message })
    });
    
    if (!res.ok) {
      throw new Error('Failed to get response from chatbot');
    }
    
    const data = await res.json();
    
    // Hide typing indicator
    hideTypingIndicator();
    
    // Add bot response to chat
    addChatMessage(data.answer || 'Sorry, I could not process your request.', false);
    chatbotMessages.push({ role: 'assistant', content: data.response });
    
  } catch (error) {
    hideTypingIndicator();
    addChatMessage('Sorry, I encountered an error. Please try again.', false);
    console.error('Chatbot error:', error);
  } finally {
    sendBtn.disabled = false;
    input.focus();
  }
}

function handleChatbotEnter(event) {
  if (event.key === 'Enter') {
    event.preventDefault();
    sendChatbotMessage();
  }
}

/* ---------- INIT ---------- */
if(token) startApp();
</script>
</body>
</html>